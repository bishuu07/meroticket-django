<!DOCTYPE html>
<html>
<head>
    <title>Checkout</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://khalti.com/static/khalti-checkout.js"></script>
</head>
<body>

<div class="container mt-4">
    <h3>Ticket Summary</h3>

    <div class="card p-3 mt-3">
        <h5>{{ ticket_type.name }}</h5>
        <p>Price: Rs. {{ ticket_type.price }}</p>
        <p>Event: {{ ticket_type.event.name }}</p>

        <button id="khalti-button" class="btn btn-success mt-3">Buy Now</button>
    </div>
</div>

<script>
    var config = {
        "publicKey": "{{ KHALTI_PUBLIC_KEY }}",
        "productIdentity": "{{ ticket_type.id }}",
        "productName": "{{ ticket_type.name }}",
        "productUrl": window.location.href,
        "eventHandler": {
            onSuccess (payload) {
                // Send payload to Django to verify and create ticket
                fetch("{% url 'verify_payment' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: JSON.stringify({
                        "token": payload.token,
                        "amount": payload.amount,
                        "ticket_type_id": {{ ticket_type.id }}
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success){
                        // Redirect to ticket success page
                        window.location.href = `/success/${data.ticket_id}/`;
                    } else {
                        alert("Payment verification failed!");
                    }
                });
            },
            onError (error) {
                console.log(error);
                alert("Payment failed!");
            },
            onClose () {
                console.log("Widget closed");
            }
        }
    };

    var checkout = new KhaltiCheckout(config);
    document.getElementById("khalti-button").onclick = function () {
        checkout.show({amount: {{ ticket_type.price|floatformat:0 }} * 100, sandbox: true});
    };
</script>

</body>
</html>
